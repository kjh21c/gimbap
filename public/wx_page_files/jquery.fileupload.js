(function(e){"function"===typeof define&&define.amd?define(["jquery","./vendor/jquery.ui.widget","./jquery.iframe-transport"],e):e(window.jQuery)})(function(e){e.widget("blueimp.fileupload",{options:{namespace:void 0,dropZone:e(document),fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,sequentialUploads:!1,limitConcurrentUploads:void 0,forceIframeTransport:!1,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,
formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput"],_isXHRUpload:function(a){return!a.forceIframeTransport&&"undefined"!==typeof XMLHttpRequestUpload&&"undefined"!==typeof File&&(!a.multipart||"undefined"!==typeof FormData)},_getFormData:function(a){if("function"===typeof a.formData)return a.formData(a.form);if(e.isArray(a.formData))return a.formData;if(a.formData){var b=[];e.each(a.formData,
function(a,d){b.push({name:a,value:d})});return b}return[]},_getTotal:function(a){var b=0;e.each(a,function(a,d){b+=d.size||1});return b},_onProgress:function(a,b){if(a.lengthComputable){var c=b.total||this._getTotal(b.files),d=parseInt(a.loaded/a.total*(b.chunkSize||c),10)+(b.uploadedBytes||0);this._loaded+=d-(b.loaded||b.uploadedBytes||0);b.lengthComputable=!0;b.loaded=d;b.total=c;this._trigger("progress",a,b);this._trigger("progressall",a,{lengthComputable:!0,loaded:this._loaded,total:this._total})}},
_initProgressListener:function(a){var b=this,c=a.xhr?a.xhr():e.ajaxSettings.xhr();c.upload&&(e(c.upload).bind("progress",function(c){var d=c.originalEvent;c.lengthComputable=d.lengthComputable;c.loaded=d.loaded;c.total=d.total;b._onProgress(c,a)}),a.xhr=function(){return c})},_initXHRData:function(a){var b=a.files[0];if(!a.multipart||a.blob)(a.headers=e.extend(a.headers,{"X-File-Name":b.name,"X-File-Type":b.type,"X-File-Size":b.size}),a.blob)?a.multipart||(a.contentType="application/octet-stream",
a.data=a.blob):(a.contentType=b.type,a.data=b);if(a.multipart&&"undefined"!==typeof FormData){if(a.postMessage){var c=this._getFormData(a);a.blob?c.push({name:a.paramName,value:a.blob}):e.each(a.files,function(b,e){c.push({name:a.paramName,value:e})})}else a.formData instanceof FormData?c=a.formData:(c=new FormData,e.each(this._getFormData(a),function(a,b){c.append(b.name,b.value)})),a.blob?c.append(a.paramName,a.blob):e.each(a.files,function(b,e){e instanceof Blob&&c.append(a.paramName,e)});a.data=
c}a.blob=null},_initIframeSettings:function(a){a.dataType="iframe "+(a.dataType||"");a.formData=this._getFormData(a)},_initDataSettings:function(a){this._isXHRUpload(a)?(this._chunkedUpload(a,!0)||(a.data||this._initXHRData(a),this._initProgressListener(a)),a.postMessage&&(a.dataType="postmessage "+(a.dataType||""))):this._initIframeSettings(a,"iframe")},_initFormSettings:function(a){a.form&&a.form.length||(a.form=e(a.fileInput.prop("form")));a.paramName||(a.paramName=a.fileInput.prop("name")||"files[]");
a.url||(a.url=a.form.prop("action")||location.href);a.type=(a.type||a.form.prop("method")||"").toUpperCase();"POST"!==a.type&&"PUT"!==a.type&&(a.type="POST")},_getAJAXSettings:function(a){a=e.extend({},this.options,a);this._initFormSettings(a);this._initDataSettings(a);return a},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var d=e.Deferred(),f=d.promise();b=b||this.options.context||f;!0===a?d.resolveWith(b,c):!1===a&&d.rejectWith(b,
c);f.abort=d.promise;return this._enhancePromise(f)},_chunkedUpload:function(a,b){var c=this,d=a.files[0],f=d.size,g=a.uploadedBytes=a.uploadedBytes||0,h=a.maxChunkSize||f,k=d.webkitSlice||d.mozSlice||d.slice,l;if(!(this._isXHRUpload(a)&&k&&(g||h<f))||a.data)return!1;if(b)return!0;if(g>=f)return d.error="uploadedBytes",this._getXHRPromise(!1,a.context,[null,"error",d.error]);f=Math.ceil((f-g)/h);var m=function(b){return b?m(--b).pipe(function(){var f=e.extend({},a);f.blob=k.call(d,g+b*h,g+(b+1)*h);
f.chunkSize=f.blob.size;c._initXHRData(f);c._initProgressListener(f);return l=(e.ajax(f)||c._getXHRPromise(!1,f.context)).done(function(){f.loaded||c._onProgress(e.Event("progress",{lengthComputable:!0,loaded:f.chunkSize,total:f.chunkSize}),f);a.uploadedBytes=f.uploadedBytes+=f.chunkSize})}):c._getXHRPromise(!0,a.context)};f=m(f);f.abort=function(){return l.abort()};return this._enhancePromise(f)},_beforeSend:function(a,b){0===this._active&&this._trigger("start");this._active+=1;this._loaded+=b.uploadedBytes||
0;this._total+=this._getTotal(b.files)},_onDone:function(a,b,c,d){this._isXHRUpload(d)||this._onProgress(e.Event("progress",{lengthComputable:!0,loaded:1,total:1}),d);d.result=a;d.textStatus=b;d.jqXHR=c;this._trigger("done",null,d)},_onFail:function(a,b,c,d){d.jqXHR=a;d.textStatus=b;d.errorThrown=c;this._trigger("fail",null,d);d.recalculateProgress&&(this._loaded-=d.loaded||d.uploadedBytes||0,this._total-=d.total||this._getTotal(d.files))},_onAlways:function(a,b,c,d){--this._active;d.textStatus=b;
c&&c.always?(d.jqXHR=c,d.result=a):(d.jqXHR=a,d.errorThrown=c);this._trigger("always",null,d);0===this._active&&(this._trigger("stop"),this._loaded=this._total=0)},_onSend:function(a,b){var c=this,d,f=c._getAJAXSettings(b),g=function(b,g){c._sending+=1;return d=d||(!1!==b&&!1!==c._trigger("send",a,f)&&(c._chunkedUpload(f)||e.ajax(f))||c._getXHRPromise(!1,f.context,g)).done(function(a,b,d){c._onDone(a,b,d,f)}).fail(function(a,b,d){c._onFail(a,b,d,f)}).always(function(a,b,d){--c._sending;c._onAlways(a,
b,d,f);if(f.limitConcurrentUploads&&f.limitConcurrentUploads>c._sending)for(a=c._slots.shift();a;){if(!a.isRejected()){a.resolve();break}a=c._slots.shift()}})};this._beforeSend(a,f);if(this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending){if(1<this.options.limitConcurrentUploads){var h=e.Deferred();this._slots.push(h);var k=h.pipe(g)}else k=this._sequence=this._sequence.pipe(g,g);k.abort=function(){var a=[void 0,"abort","abort"];return d?
d.abort():(h&&h.rejectWith(a),g(!1,a))};return this._enhancePromise(k)}return g()},_onAdd:function(a,b){var c=this,d=!0,f=e.extend({},this.options,b),g=f.limitMultiFileUploads;if(!f.singleFileUploads&&!g||!this._isXHRUpload(f))var h=[b.files];else if(!f.singleFileUploads&&g)for(h=[],f=0;f<b.files.length;f+=g)h.push(b.files.slice(f,f+g));b.originalFiles=b.files;e.each(h||b.files,function(f,g){var k=e.extend({},b,{files:h?g:[g]});k.submit=function(){return k.jqXHR=this.jqXHR=!1!==c._trigger("submit",
a,this)&&c._onSend(a,this)};return d=c._trigger("add",a,k)});return d},_normalizeFile:function(a,b){void 0===b.name&&void 0===b.size&&(b.name=b.fileName,b.size=b.fileSize)},_replaceFileInput:function(a){var b=a.clone(!0);e("<form></form>").append(b)[0].reset();a.after(b).detach();e.cleanData(a.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(c,d){return d===a[0]?b[0]:d});a[0]===this.element[0]&&(this.element=b)},_onChange:function(a){var b=a.data.fileupload,c={files:e.each(e.makeArray(a.target.files),
b._normalizeFile),fileInput:e(a.target),form:e(a.target.form)};c.files.length||(c.files=[{name:a.target.value.replace(/^.*\\/,"")}]);b.options.replaceFileInput&&b._replaceFileInput(c.fileInput);if(!1===b._trigger("change",a,c)||!1===b._onAdd(a,c))return!1},_onPaste:function(a){var b=a.data.fileupload,c=a.originalEvent.clipboardData,d={files:[]};e.each(c&&c.items||[],function(a,b){var c=b.getAsFile&&b.getAsFile();c&&d.files.push(c)});if(!1===b._trigger("paste",a,d)||!1===b._onAdd(a,d))return!1},_onDrop:function(a){var b=
a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;c={files:e.each(e.makeArray(c&&c.files),b._normalizeFile)};if(!1===b._trigger("drop",a,c)||!1===b._onAdd(a,c))return!1;a.preventDefault()},_onDragOver:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;if(!1===b._trigger("dragover",a))return!1;c&&(c.dropEffect=c.effectAllowed="copy");a.preventDefault()},_initEventHandlers:function(){var a=this.options.namespace;this.options.dropZone.bind("dragover."+a,{fileupload:this},
this._onDragOver).bind("drop."+a,{fileupload:this},this._onDrop).bind("paste."+a,{fileupload:this},this._onPaste);this.options.fileInput.bind("change."+a,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var a=this.options.namespace;this.options.dropZone.unbind("dragover."+a,this._onDragOver).unbind("drop."+a,this._onDrop).unbind("paste."+a,this._onPaste);this.options.fileInput.unbind("change."+a,this._onChange)},_beforeSetOption:function(a,b){this._destroyEventHandlers()},_afterSetOption:function(a,
b){var c=this.options;c.fileInput||(c.fileInput=e());c.dropZone||(c.dropZone=e());this._initEventHandlers()},_setOption:function(a,b){var c=-1!==e.inArray(a,this._refreshOptionsList);c&&this._beforeSetOption(a,b);e.Widget.prototype._setOption.call(this,a,b);c&&this._afterSetOption(a,b)},_create:function(){var a=this.options;a.namespace=a.namespace||this.widgetName;void 0===a.fileInput?a.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file"):a.fileInput||(a.fileInput=
e());a.dropZone||(a.dropZone=e());this._slots=[];this._sequence=this._getXHRPromise(!0);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();e.Widget.prototype.destroy.call(this)},enable:function(){e.Widget.prototype.enable.call(this);this._initEventHandlers()},disable:function(){this._destroyEventHandlers();e.Widget.prototype.disable.call(this)},add:function(a){a&&!this.options.disabled&&(a.files=e.each(e.makeArray(a.files),
this._normalizeFile),this._onAdd(null,a))},send:function(a){return a&&!this.options.disabled&&(a.files=e.each(e.makeArray(a.files),this._normalizeFile),a.files.length)?this._onSend(null,a):this._getXHRPromise(!1,a&&a.context)}})});